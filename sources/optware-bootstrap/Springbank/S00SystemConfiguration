#! /bin/bash

if [ ! -b /dev/sda3  ]
then
fdisk /dev/sda <<EOF1
n
p
3
4194368
20971583
t
3
82
w
EOF1
partprobe
mkswap /dev/sda3
fi

if [ ! -b /dev/sda4  ]
then
fdisk /dev/sda <<EOF2
n
p
4
20971584

w
EOF2
partprobe
file -s /dev/sda4 | grep ext4
    if [[ $? != 0 ]]
    then
        mkfs.ext4 -L persistence /dev/sda4
        mkdir -p /mnt/home
        mount /dev/sda4 /mnt/home
        echo '/home union' >> /mnt/home/persistence.conf
        umount /mnt/home
        rm -rf /mnt/home
    fi
reboot
fi

/opt/bin/ipkg list_installed | grep endor >/dev/null
if [[ $? != 0 ]]
then

	CONNECTED=1
	i=0

	# Wait for network
	while [ $CONNECTED -ne "0" ]
	do

		ping -c 1 packages.calnexsol.com >/dev/null
		CONNECTED=$?
		((i++))
		if [[ $i -gt 2000 ]]
		then
			CONNECTED=0
		fi
	done

	su - calnex -c '/opt/bin/ipkg update'
	su - calnex -c '/opt/bin/ipkg install endor'
fi

