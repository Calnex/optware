#! /bin/bash

if [ ! -b /dev/sda3  ]
then
fdisk /dev/sda <<EOF1
n
p
3
4194368
20971583
t
3
82
w
EOF1
partprobe
mkswap /dev/sda3
else
swapon -e /dev/sda3
fi

if [ ! -b /dev/sda4  ]
then
fdisk /dev/sda <<EOF2
n
p
4
20971584

w
EOF2
partprobe
file -s /dev/sda4 | grep ext4
    if [[ $? != 0 ]]
    then
        mkfs.ext4 -L persistence /dev/sda4
        mkdir -p /mnt/home
        mount /dev/sda4 /mnt/home
        echo '/home union' >> /mnt/home/persistence.conf
        echo '/var/lib/dhcp3/dhclient.leases union' >> /mnt/home/persistence.conf
        umount /mnt/home
        rm -rf /mnt/home
    fi
reboot
fi

# Debian self install
if [[ -e /opt/var/lib/debian/root.img ]]
then
	cd /opt/var/lib/debian/
	OLD_PARTITION=$(fdisk -l /dev/sda | awk '$2 == "*" {print $1}')
	OLD_PARTITION="${OLD_PARTITION: -1}"
	if [ "$OLD_PARTITION" = "1" ]
	then
		$NEW_PARTITION=2
	else
		$NEW_PARTITION=1
	fi
	CSUM_ROOT=$(md5sum /dev/sda$OLD_PARTITION | grep --only-matching -m 1 '^[0-9a-f]*')
	CSUM_IMG=$(md5sum root.img | grep --only-matching -m 1 '^[0-9a-f]*')
	if [ "$CSUM_ROOT" != "$CSUM_IMG" ]
	then
		gpg --verify root.img.asc root.img
		if [ $? = 0 ]
		then
IMG_SIZE=$(ls -l root.img | awk '{print $5}')
fdisk /dev/sda << EOF3
d
${NEW_PARTITION}
w
EOF3
partprobe
fdisk /dev/sda << EOF4
n
p
2097216
+$(($IMG_SIZE/512))
w
EOF4
partprobe
dd if=root.img of=/dev/sda${NEW_PARTITION}
sync
fdisk /dev/sda << EOF5
a
${NEW_PARTITION}
a
${OLD_PARTITION}
w
EOF5
sync
reboot
		else
			echo "Debian update image keysign check failed!"
		fi
	fi
# Optware self install
cp /lib/live/mount/rootfs/filesystem.squashfs/home/.optware/lib/ipkg/info/*.control /opt/lib/ipkg/info/
/opt/bin/ipkg_rebuild > /opt/lib/ipkg/info/status

/opt/bin/ipkg list_installed | grep endor >/dev/null
if [[ $? != 0 ]]
then

	ATTCHED=`cat /sys/class/net/eth0/carrier`
	NETFAIL=0
	if [ $ATTCHED -ne "0" ]
	then

		CONNECTED=1
		i=0

		voodoo dhclient

		# Wait for network
		while [ $CONNECTED -ne "0" ]
		do

			ping -c 1 packages.calnexsol.com >/dev/null
			sleep 0.1
			CONNECTED=$?
			((i++))
			if [[ $i -gt 2000 ]]
			then
				CONNECTED=0
				NETFAIL=1
			fi
		done
	else
		NETFAIL=1
	fi

	if [ $NETFAIL -ne "0" ]
	then
		cat '#! /bin/sh'                                                             >  /sbin/get-ip-address
		cat 'echo "Please insert installation media and run the following commands"' >> /sbin/get-ip-address
		cat 'echo "ipkg update"'                                                     >> /sbin/get-ip-address
		cat 'echo "ipkg install endor"'                                              >> /sbin/get-ip-address
		cat 'echo "reboot"'                                                          >> /sbin/get-ip-address

	else
		su - calnex -c '/opt/bin/ipkg update'
		su - calnex -c '/opt/bin/ipkg install endor-__TARGET_PRODUCT__'
		reboot
	fi
fi

cp /opt/etc/cron.d/* /etc/cron.daily/

/sbin/ip_fallback &
