#! /bin/bash

if [ ! -b /dev/sda3  ]
then
fdisk /dev/sda <<EOF1
n
p
3
4194368
20971583
t
3
82
w
EOF1
partprobe
mkswap /dev/sda3
else
swapon -e /dev/sda3
fi

if [ ! -b /dev/sda4  ]
then
fdisk /dev/sda <<EOF2
n
p
4
20971584

w
EOF2
partprobe
file -s /dev/sda4 | grep ext4
    if [[ $? != 0 ]]
    then
        mkfs.ext4 -L persistence /dev/sda4
        mkdir -p /mnt/home
        mount /dev/sda4 /mnt/home
        echo '/home union' >> /mnt/home/persistence.conf
        echo '/var/lib/dhcp3/dhclient.leases union' >> /mnt/home/persistence.conf
        umount /mnt/home
        rm -rf /mnt/home
    fi
reboot
fi

# Debian self install
if [[ -e /opt/var/lib/debian/root.img ]]
then
	cd /opt/var/lib/debian/
	OLD_PARTITION=$(fdisk -l /dev/sda | awk '$2 == "*" {print $1}')
	OLD_PARTITION="${OLD_PARTITION: -1}"
	if [ "$OLD_PARTITION" = "1" ]
	then
		NEW_PARTITION=2
	else
		NEW_PARTITION=1
	fi
	CSUM_ROOT=$(md5sum /dev/sda$OLD_PARTITION | grep --only-matching -m 1 '^[0-9a-f]*')
	CSUM_IMG=$(md5sum root.img | grep --only-matching -m 1 '^[0-9a-f]*')
	if [ "$CSUM_ROOT" != "$CSUM_IMG" ]
	then
		gpg --verify root.img.asc root.img 2>/dev/null
		if [ $? = 0 ]
		then
IMG_SIZE=$(ls -l root.img | awk '{print $5}')
fdisk /dev/sda << EOF3
d
${NEW_PARTITION}
w
EOF3
partprobe
fdisk /dev/sda << EOF4
n
p
2097216
+$(($IMG_SIZE/512))
w
EOF4
partprobe
dd if=root.img of=/dev/sda${NEW_PARTITION}
sync
fdisk /dev/sda << EOF5
a
${NEW_PARTITION}
a
${OLD_PARTITION}
w
EOF5
sync
reboot
		else
			echo "Debian update image keysign check failed!"
		fi
	fi
fi

cp /opt/etc/cron.d/* /etc/cron.daily/

/sbin/ip_fallback &
