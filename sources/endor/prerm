#!/bin/sh

# Try to save any persistent data from the database
#
/opt/etc/init.d/S95postgresql start

pgdata=/opt/var/pgsql/data
wait_count=20

pg_ctl status -D $pgdata
pg_running=$?

while [ ${pg_running} -ne 0 ] && [ ${wait_count} -ne 0 ]
do
    echo "Database not running, waiting..."
    sleep 0.5
    pg_ctl status -D $pgdata
    pg_running=$?
    wait_count=$(expr $wait_count - 1)
done

# Exit if we have failed
#
if [ $wait_count -eq 0 ]; then
    echo "Failed to start database in Endor Postinst"
    exit 1
fi

if [ -e /opt/lib/endor/utility/save_persistent_data.py ]; then
    echo "Saving persistent database settings"
    mkdir -p /opt/var/lib/endor
    python3 /opt/lib/endor/utility/save_persistent_data.py > /opt/var/lib/endor/endor_saved_state.txt
fi

/opt/etc/init.d/S99endor-webapp stop
/opt/etc/init.d/S98cat-remotingserver stop
/opt/etc/init.d/S97endor-instrumentcontroller stop

if [ -e /opt/etc/init.d/S96endor-virtualinstrument ]; then
    /opt/etc/init.d/S96endor-virtualinstrument stop
fi

sleep 1

rm -rf /opt/lib/endor/CAT
cd /opt/lib/mono
rm -f `tar -tzf /opt/lib/endor/long-filepaths.tar.gz`
