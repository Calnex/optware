#!/bin/sh

cd /opt/lib/endor
tar -xzf long-filepaths.tar.gz

#
# This block sets up the machine as a real machine,
# that speaks to a physical embedded.
#
if [ -e /opt/bin/calnex.endor.instrument.controller ]; then
    rm /opt/bin/calnex.endor.instrument.controller
fi

ln -s  /opt/bin/calnex.endor.instrument.controller.physicalinstrument /opt/bin/calnex.endor.instrument.controller 

/opt/etc/init.d/S95postgresql stop
sleep 3

/opt/lib/ipkg/info/postgresql.postinst

echo "********************"
echo "ENDOR POSTINST: Returned from postgres postinst"
echo ""
ps aux | grep -i post

echo ""

echo "Listing the database startup script:"
ls -l /opt/et5c/init.d/S95postgresql

/opt/et5c/init.d/S95postgresql start
echo "waiting for DB daemon to start"


pg_ctl status -D $pgdata
pg_running=3
while [ $pg_running != 0 ]
do
    echo "Not running yet, sleeping..."
    sleep 0.5
    pg_ctl status -D $pgdata
    pg_running=$?
done

echo "Database reports itself running"


# Debugging code added here.
# 
#

echo ""
echo "We asked the database daemon to start three seconds ago"
echo ""
ps aux | grep -i post

echo "Let's try to connect to it"
echo "First using localhost"
psql -h localhost -U calnex -d postgres -c "\dt"

echo "**************************"
echo "Let's try to connect to it"
echo "Now using 127.0.0.1"
psql -h 127.0.0.1 -U calnex -d postgres -c "\dt"

echo "Finally a list of processes"
ps aux

#
#
# End of debugging code


python3 /opt/lib/endor/schema/Baseline/RebuildDb.py --superuser calnex --path /opt/lib/endor/schema/Baseline

# And if any saved data exists, put that into the database too
#
if [ -e /opt/lib/endor/utility/restore_persistent_data.py ]; then
    if [ -e ${HOME}/endor_saved_state.txt ]; then
        echo "Restoring saved database settings"
        python3 /opt/lib/endor/utility/restore_persistent_data.py < ${HOME}/endor_saved_state.txt
        rm -f ${HOME}/endor_saved_state.txt
    fi
fi

/opt/etc/init.d/S95postgresql stop
# /opt/etc/init.d/S96endor-virtualinstrument start
# /opt/etc/init.d/S97endor-instrumentcontroller start
# /opt/etc/init.d/S98cat-remotingserver start
# /opt/etc/init.d/S99endor-webapp start
